<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Editar Visita</title>
</head>
<body>
  <h1>Editar Visita</h1>
  <form id="form-editar">
    <input type="hidden" id="id" />
    <label>Nombre: <input type="text" id="Nombre" required></label><br/>
    <label>Apellido: <input type="text" id="Apellido" required></label><br/>
    <label>DNI: <input type="text" id="DNI" required></label><br/>
    <label>Persona Visitada: <input type="text" id="Persona_visitada"></label><br/>
    <label>Motivo: <input type="text" id="Motivo"></label><br/>
    <label>Fecha Ingreso: <input type="date" id="fecha_ingreso"></label><br/>
    <label>Hora Ingreso: <input type="time" id="hora_ingreso"></label><br/>
    <label>Fecha Salida: <input type="date" id="fecha_salida"></label><br/>
    <label>Hora Salida: <input type="time" id="hora_salida"></label><br/>
    <button type="submit">Guardar cambios</button>
  </form>

<script>
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get('id');

if (!id) {
  alert("ID inv√°lido");
  window.location.href = "buscar.html";
}

async function cargarDatos() {
  try {
    const res = await fetch(`/visitas_edificio/php/editarget.php?id=${id}`);
    if (!res.ok) throw new Error("Error al cargar datos");
    const visita = await res.json();

    if (visita.error) {
      alert(visita.error);
      window.location.href = "buscar.html";
      return;
    }

    document.getElementById('id').value = visita.id;
    document.getElementById('Nombre').value = visita.Nombre || '';
    document.getElementById('Apellido').value = visita.Apellido || '';
    document.getElementById('DNI').value = visita.DNI || '';
    document.getElementById('Persona_visitada').value = visita.Persona_visitada || '';
    document.getElementById('Motivo').value = visita.Motivo || '';
    document.getElementById('fecha_ingreso').value = visita.fecha_ingreso || '';
    document.getElementById('hora_ingreso').value = visita.hora_ingreso || '';
    document.getElementById('fecha_salida').value = visita.fecha_salida || '';
    document.getElementById('hora_salida').value = visita.hora_salida || '';
  } catch (error) {
    alert("No se pudo cargar la visita.");
    window.location.href = "buscar.html";
  }
}

document.getElementById('form-editar').addEventListener('submit', async function(e) {
  e.preventDefault();
  const datos = {
    id: document.getElementById('id').value,
    Nombre: document.getElementById('Nombre').value,
    Apellido: document.getElementById('Apellido').value,
    DNI: document.getElementById('DNI').value,
    Persona_visitada: document.getElementById('Persona_visitada').value,
    Motivo: document.getElementById('Motivo').value,
    fecha_ingreso: document.getElementById('fecha_ingreso').value,
    hora_ingreso: document.getElementById('hora_ingreso').value,
    fecha_salida: document.getElementById('fecha_salida').value,
    hora_salida: document.getElementById('hora_salida').value
  };

  try {
    const res = await fetch('/visitas_edificio/php/editarset.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(datos)
    });
    const data = await res.json();
    if (data.exito) {
      alert("Registro actualizado correctamente.");
      window.location.href = "buscar.html";
    } else {
      alert(data.error || "No se pudo actualizar el registro.");
    }
  } catch (error) {
    alert("Error al actualizar registro.");
  }
});

cargarDatos();
</script>
</body>
</html>
